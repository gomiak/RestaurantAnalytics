@page "/custom-dashboard"
@attribute [Authorize]

@using Microsoft.AspNetCore.Authorization
@using MudBlazor
@using RestaurantAnalytics.Application.Analytics
@using RestaurantAnalytics.Core.Interfaces
@inject ISalesRepository Repository
@inject IAiInsightsService AiInsightsService
@inject IJSRuntime JS

<MudPaper Class="pa-4">

    <MudText Typo="Typo.h5" Class="mb-4">Criar Gráfico Personalizado</MudText>

    <MudGrid GutterSize="3">

        <MudItem xs="12" md="4">
            <MudSelect T="string" Label="Métrica" @bind-Value="_selectedMetric">
                @foreach (var m in AnalyticsCatalog.Metrics)
                {
                    <MudSelectItem Value="@m.Key">@m.Label</MudSelectItem>
                }
            </MudSelect>
        </MudItem>

        <MudItem xs="12" md="4">
            <MudSelect T="string" Label="Agrupar Por" @bind-Value="_selectedDimension">
                @foreach (var d in AnalyticsCatalog.Dimensions)
                {
                    <MudSelectItem Value="@d.Key">@d.Label</MudSelectItem>
                }
            </MudSelect>
        </MudItem>

        <MudItem xs="12" md="4">
            <MudSelect T="ChartType" Label="Tipo de Gráfico" @bind-Value="_chartType">
                <MudSelectItem Value="ChartType.Line">Linha</MudSelectItem>
                <MudSelectItem Value="ChartType.Bar">Barra</MudSelectItem>
                <MudSelectItem Value="ChartType.Pie">Pizza</MudSelectItem>
            </MudSelect>
        </MudItem>

        <MudItem xs="12" md="6">
            <MudDateRangePicker Label="Período" @bind-DateRange="_dateRange" />
        </MudItem>

        <MudItem xs="12" md="6">
            <MudSelect T="int?" Label="Loja" @bind-Value="_selectedStoreId" Clearable="true">
                <MudSelectItem Value="@((int?)null)">Todas</MudSelectItem>
                @foreach (var s in _stores)
                {
                    <MudSelectItem T="int?" Value="@s.Id">@s.Name</MudSelectItem>
                }
            </MudSelect>
        </MudItem>

        <MudItem xs="12" md="6">
            <MudSelect T="int?" Label="Canal" @bind-Value="_selectedChannelId" Clearable="true">
                <MudSelectItem Value="@((int?)null)">Todos</MudSelectItem>
                @foreach (var c in _channels)
                {
                    <MudSelectItem T="int?" Value="@c.Id">@($"{(c.Type == "D" ? "Delivery" : "Presencial")} - {c.Name}")</MudSelectItem>
                }
            </MudSelect>
        </MudItem>

        <MudItem xs="12" md="6">
            <MudAutocomplete T="ProductOption"
                             Label="Produto"
                             @bind-Value="_selectedProduct"
                             SearchFunc="SearchProducts"
                             ToStringFunc="p => p?.Name ?? string.Empty"
                             Clearable="true"
                             ResetValueOnEmptyText="true" />
        </MudItem>

        <MudItem xs="12">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadChart">
                Gerar Gráfico
            </MudButton>
        </MudItem>

    </MudGrid>

    @if (_chartSeries is not null)
    {
        <MudDivider Class="my-4" />

        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudText Typo="Typo.h6">Resultado</MudText>

            <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="ExplainChart">
                Explicar gráfico
            </MudButton>

            <MudButton Variant="Variant.Outlined" Color="Color.Info" OnClick="ExportExcel">
                Exportar Excel
            </MudButton>

            <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="ExportPdf">
                Exportar PDF
            </MudButton>
        </MudStack>

        @if (!string.IsNullOrEmpty(_insight))
        {
            <MudAlert Severity="Severity.Info" Class="mt-2">
                @_insight
            </MudAlert>
        }

        <div id="export-area">
            <MudChart ChartType="@_chartType"
                      ChartSeries="@_chartSeries"
                      XAxisLabels="@_chartLabels"
                      ChartOptions="@_chartOptions"
                      Width="900px"
                      Height="450px" />

            <MudDivider Class="my-4" />

            <MudText Typo="Typo.h6" Class="mb-2">Tabela de Valores</MudText>

            <MudTable T="(string Label, decimal Value)" Items="_tableData" Dense="true" Hover="true" Bordered="true">
                <HeaderContent>
                    <MudTh>Label</MudTh>
                    <MudTh style="text-align:right;">Valor</MudTh>
                </HeaderContent>

                <RowTemplate>
                    <MudTd>@context.Label</MudTd>
                    <MudTd style="text-align:right;">@context.Value.ToString("C")</MudTd>
                </RowTemplate>
            </MudTable>
        </div>
    }

</MudPaper>

@code {
    public record ProductOption(int Id, string Name);

    private string _selectedMetric = AnalyticsCatalog.Metrics.First().Key;
    private string _selectedDimension = AnalyticsCatalog.Dimensions.First().Key;
    private ChartType _chartType = ChartType.Bar;

    private DateRange _dateRange = new(DateTime.UtcNow.AddDays(-30), DateTime.UtcNow);
    private int? _selectedStoreId = null;
    private int? _selectedChannelId = null;
    private ProductOption? _selectedProduct = null;

    private List<(int Id, string Name)> _stores = new();
    private List<(int Id, string Name, string Type)> _channels = new();

    private List<(string Label, decimal Value)> _tableData = new();
    private List<ChartSeries>? _chartSeries;
    private string[] _chartLabels = Array.Empty<string>();
    private ChartOptions _chartOptions = new();
    private string? _insight;

    protected override async Task OnInitializedAsync()
    {
        _stores = (await Repository.GetStoresAsync()).ToList();
        _channels = (await Repository.GetChannelsAsync()).ToList();
    }

    private async Task<IEnumerable<ProductOption>> SearchProducts(string value, CancellationToken token)
    {
        if (string.IsNullOrWhiteSpace(value))
            return Enumerable.Empty<ProductOption>();
        var result = await Repository.SearchProductsAsync(value);
        return result.Select(p => new ProductOption(p.Id, p.Name));
    }

    private async Task LoadChart()
    {
        _insight = null;

        var metric = AnalyticsCatalog.Metrics.First(m => m.Key == _selectedMetric);
        var dimension = AnalyticsCatalog.Dimensions.First(d => d.Key == _selectedDimension);

        var start = _dateRange.Start ?? DateTime.UtcNow.AddDays(-30);
        var end = _dateRange.End ?? DateTime.UtcNow;

        var result = (await Repository.RunCustomQueryAsync(
            metric, dimension, start, end,
            _selectedStoreId, _selectedChannelId, _selectedProduct?.Id
        )).ToList();

        _tableData = result;

        var labelsList = result.Select(r => r.Label).ToList();
        const int maxLabels = 12;
        _chartLabels = labelsList.Count > maxLabels
            ? labelsList.Select((v, i) => i % (int)Math.Ceiling((double)labelsList.Count / maxLabels) == 0 ? v : "").ToArray()
            : labelsList.ToArray();

        var rawValues = result.Select(r => (double)r.Value).ToArray();

        if (!rawValues.Any())
        {
            _chartSeries = null;
            _chartOptions = new ChartOptions();
            return;
        }

        bool useK = rawValues.Any(v => v >= 1000);
        double divisor = useK ? 1000.0 : 1.0;
        string suffix = useK ? " (K)" : "";
        var scaled = rawValues.Select(v => v / divisor).ToArray();

        _chartOptions = new ChartOptions
            {
                YAxisFormat = useK ? "0.#K" : "0.##",
                YAxisTicks = 5
            };

        _chartSeries = new()
        {
            new ChartSeries
            {
                Name = metric.Label + suffix,
                Data = scaled,
                ShowDataMarkers = scaled.Length <= 50
            }
        };
    }

    private async Task ExplainChart()
    {
        if (!_tableData.Any())
            return;

        var metric = AnalyticsCatalog.Metrics.First(m => m.Key == _selectedMetric);
        var dimension = AnalyticsCatalog.Dimensions.First(d => d.Key == _selectedDimension);

        _insight = await AiInsightsService.GenerateLabelValueInsightAsync(
            _tableData, metric.Label, dimension.Label);
    }

    private async Task ExportExcel()
    {
        if (_tableData is null || !_tableData.Any())
            return;

        using var workbook = new ClosedXML.Excel.XLWorkbook();
        var sheet = workbook.AddWorksheet("Dados");

        sheet.Cell(1, 1).Value = "Label";
        sheet.Cell(1, 2).Value = "Valor";

        for (int i = 0; i < _tableData.Count; i++)
        {
            sheet.Cell(i + 2, 1).Value = _tableData[i].Label;
            sheet.Cell(i + 2, 2).Value = _tableData[i].Value;
        }

        sheet.Columns().AdjustToContents();

        using var stream = new MemoryStream();
        workbook.SaveAs(stream);
        stream.Position = 0;

        var base64 = Convert.ToBase64String(stream.ToArray());
        await JS.InvokeVoidAsync("downloadFileFromBase64", base64, "relatorio.xlsx");
    }

    private async Task ExportPdf()
    {
        await JS.InvokeVoidAsync("exportCustomDashboardPdfWithFilters",
            "export-area",
            _selectedMetric,
            _selectedDimension,
            _selectedStoreId.HasValue ? _stores.First(s => s.Id == _selectedStoreId.Value).Name : "Todas",
            _selectedChannelId.HasValue ? _channels.First(c => c.Id == _selectedChannelId.Value).Name : "Todos",
            _selectedProduct?.Name ?? "Todos",
            _dateRange.Start?.ToString("dd/MM/yyyy") ?? "",
            _dateRange.End?.ToString("dd/MM/yyyy") ?? ""
        );
    }
}
