@using RestaurantAnalytics.Core.Interfaces
@using Components.Pages.Dashboards.Charts
@inject ISalesRepository Repository

<MudCard Class="pa-4">
    <MudText Typo="Typo.h6">Faturamento Mensal (últimos 6 meses)</MudText>

    <MudChart ChartType="ChartType.Bar"
              ChartSeries="@_series"
              XAxisLabels="@_labels"
              Width="100%"
              Height="400px"
              ChartOptions="@_options"
              AxisChartOptions="@_axisOptions" />

    <!-- ✅ InsightBox ajustado p/ DateTime -->
    <InsightBox Data="@_revenueDict.ToDictionary(x => (object)x.Key, x => x.Value)" />
</MudCard>

@code {
    private List<ChartSeries> _series = new();
    private string[] _labels = Array.Empty<string>();

    private ChartOptions _options = new()
        {
            YAxisFormat = "0.#K"
        };

    private AxisChartOptions _axisOptions = new()
        {
            MatchBoundsToSize = true
        };

    private Dictionary<DateTime, decimal> _revenueDict = new();

    protected override async Task OnInitializedAsync()
    {
        var start = DateTime.UtcNow.AddMonths(-6);
        var end = DateTime.UtcNow;

        var sales = await Repository.GetSalesByDateRangeAsync(start, end);

        var grouped = sales
            .GroupBy(s => new { s.CreatedAt.Year, s.CreatedAt.Month })
            .Select(g => new { Label = $"{g.Key.Month:D2}/{g.Key.Year}", Total = g.Sum(x => x.TotalAmount) })
            .OrderBy(x => x.Label)
            .ToList();

        _labels = grouped.Select(x => x.Label).ToArray();

        _series = new()
        {
            new ChartSeries
            {
                Name = "Faturamento (K)",
                Data = grouped.Select(x => (double)x.Total / 1000).ToArray()
            }
        };

        _revenueDict = grouped.ToDictionary(
            x => new DateTime(int.Parse(x.Label.Split('/')[1]), int.Parse(x.Label.Split('/')[0]), 1),
            x => x.Total
        );
    }
}
